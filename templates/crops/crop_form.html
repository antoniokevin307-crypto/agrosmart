{% extends "base.html" %}
{% block content %}

<div class="card shadow-lg p-4 mb-4" style="max-width:700px;margin:auto;background:linear-gradient(120deg,#f8fff8 0%,#e0ffe0 100%);border-radius:1.2rem;">
  <h2 class="mb-3" style="font-weight:700;color:#2d6a4f;letter-spacing:1px;">{% if edit_mode %}Editar cultivo{% else %}Nuevo cultivo{% endif %}</h2>
  <form method="post">
    {% csrf_token %}
    <div class="row mb-3">
      <div class="col-md-6 mb-2">
        <label class="form-label" style="font-weight:600;">{{ form.name.label }}</label>
        {{ form.name }}
      </div>
      <!-- Country code field removed -->
    </div>
    <div class="mb-3">
      <label class="form-label" style="font-weight:600;">{{ form.description.label }}</label>
      <textarea class="form-control" name="description" rows="3" style="resize:vertical;">{{ form.description.value }}</textarea>
    </div>
    <div class="row mb-3">
      <div class="col-md-6 mb-2">
        <label class="form-label" style="font-weight:600;">{{ form.sowing_date.label }}</label>
        {{ form.sowing_date }}
      </div>
      <div class="col-md-6 mb-2">
        {# Hidden latitude/longitude fields that the map will populate #}
        {{ form.latitude }}
        {{ form.longitude }}
      </div>
    </div>

    <div class="card mb-4" style="border-radius:1rem;box-shadow:0 2px 8px #0001;">
      <div class="card-body">
        <h4 class="mb-2" style="font-weight:700;color:#2d6a4f;">Ubicación <span style="font-weight:400;font-size:1rem;">(haz clic en el mapa para colocar un pin)</span></h4>
        <div id="crop-map" style="height:300px; border:1px solid #b2f7b2; margin-bottom:1rem; border-radius:1rem;"></div>
        <div id="climate-feedback" class="mt-3" style="display:none;"></div>
        <style>
          .weather-cards-row {
            margin-bottom: 2rem;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            gap: 18px;
          }
          .weather-card {
            background: linear-gradient(90deg,#e0eafc 0%,#cfdef3 100%);
            border-radius: 1.2rem;
            box-shadow: 0 4px 24px #19875422;
            padding: 1.5rem 1rem 1rem 1rem;
            text-align: center;
            transition: transform 0.4s cubic-bezier(.4,0,.2,1), box-shadow 0.4s cubic-bezier(.4,0,.2,1);
            opacity: 1;
            transform: translateY(0) scale(1);
            margin-bottom: 0;
            min-width: 160px;
            max-width: 200px;
            flex: 1 1 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
          }
          @media (max-width: 900px) {
            .weather-cards-row {
              flex-direction: column;
              align-items: center;
            }
            .weather-card {
              flex: 1 1 100%;
              min-width: 140px;
              max-width: 350px;
              margin-bottom: 12px;
            }
          }
          .weather-card .weather-icon {
            width: 38px;
            height: 38px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
          }
          .weather-card .weather-label {
            font-weight: bold;
            color: #198754;
            font-size: 1.08rem;
            margin-bottom: 0.3rem;
          }
          .weather-card .weather-value {
            font-size: 1.35rem;
            color: #0d6efd;
            font-weight: bold;
          }
        </style>
      </div>
    </div>

    <div class="card mb-4" style="border-radius:1rem;box-shadow:0 2px 8px #0001;">
      <div class="card-body">
        <h4 class="mb-2" style="font-weight:700;color:#2d6a4f;">Fechas óptimas para plantar</h4>
        <div style="margin-bottom:8px;font-weight:bold;">{{ month }}/{{ year }}</div>
        <div id="calendar-container" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:1rem;">
          {% for day in calendar_data %}
            <span class="calendar-day" style="display:block;padding:8px 0;border-radius:4px;text-align:center;font-weight:bold;box-shadow:0 1px 4px #0001;background:#e0e0e0;color:#888;">
              {{ day.day }}
            </span>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-end">
      <button class="btn btn-cultivo" type="submit" style="min-width:140px;font-size:1.08rem;font-weight:500;border-radius:0.7rem;padding:0.55rem 1.1rem;box-shadow:0 2px 8px #6f42c133;background:linear-gradient(90deg,#e0ffe0 0%,#b2f7b2 100%);color:#2d6a4f;border:1px solid #b2f7b2;">{% if edit_mode %}Actualizar{% else %}Guardar{% endif %}</button>
      <a class="btn btn-cultivo btn-cancelar" href="{% url 'crop_list' %}" style="background:linear-gradient(90deg,#ffe0e0 0%,#f7b2b2 100%);color:#a42d2d;border:1px solid #f7b2b2;min-width:140px;font-size:1.08rem;font-weight:500;border-radius:0.7rem;padding:0.55rem 1.1rem;box-shadow:0 2px 8px #6f42c133;margin-left:8px;">Cancelar</a>
    </div>
  </form>
</div>

{% load static %}

<script>
  // Helper to add class to Django form fields
  function addClassToFormFields() {
    document.querySelectorAll('input, select, textarea').forEach(function(el) {
      if (!el.classList.contains('form-control')) {
        el.classList.add('form-control');
      }
    });
  }

  async function updateClimateFeedback(lat, lon) {
    const apiKey = 'c68ac2a4c771e0bb1ee4a3b0e24bfd81'; // API key del usuario
    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=es&appid=${apiKey}`;
    const feedback = document.getElementById('climate-feedback');
    feedback.style.display = 'block';
    feedback.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Consultando clima...';
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error('No se pudo obtener el clima');
      const data = await res.json();
      const temp = data.main.temp;
      const desc = data.weather[0].description;
      const hum = data.main.humidity;
      const wind = data.wind.speed;
      const rain = data.rain ? data.rain["1h"] || data.rain["3h"] || 0 : 0;
      feedback.innerHTML = `
        <div class="weather-cards-row">
          <div class="weather-card animate__animated animate__fadeIn">
            <div class="weather-icon">${getWeatherSVG('temp')}</div>
            <div class="weather-label">Temperatura</div>
            <div class="weather-value">${temp}°C</div>
            <div class="weather-label" style="font-weight:400;color:#555;font-size:.98rem;">${desc}</div>
          </div>
          <div class="weather-card animate__animated animate__fadeIn">
            <div class="weather-icon">${getWeatherSVG('humidity')}</div>
            <div class="weather-label">Humedad</div>
            <div class="weather-value">${hum}%</div>
          </div>
          <div class="weather-card animate__animated animate__fadeIn">
            <div class="weather-icon">${getWeatherSVG('rain')}</div>
            <div class="weather-label">Lluvia</div>
            <div class="weather-value">${rain} mm</div>
          </div>
          <div class="weather-card animate__animated animate__fadeIn">
            <div class="weather-icon">${getWeatherSVG('wind')}</div>
            <div class="weather-label">Viento</div>
            <div class="weather-value">${wind.toFixed(2)} m/s</div>
          </div>
        </div>
      `;
    } catch (err) {
      feedback.innerHTML = `<div class="alert alert-warning animate__animated animate__fadeIn">No se pudo obtener el clima.</div>`;
    }
  }

  function getWeatherSVG(type) {
    switch(type) {
      case 'temp':
        return `<svg viewBox="0 0 32 32" width="32" height="32" fill="none"><circle cx="16" cy="16" r="12" fill="#ffb347"/><rect x="14" y="8" width="4" height="12" rx="2" fill="#fff"/><rect x="14" y="20" width="4" height="4" rx="2" fill="#ffb347"/></svg>`;
      case 'humidity':
        return `<svg viewBox="0 0 32 32" width="32" height="32" fill="none"><ellipse cx="16" cy="20" rx="8" ry="10" fill="#4fc3f7"/><path d="M16 6C16 6 24 14 16 26C8 14 16 6 16 6Z" fill="#81d4fa"/></svg>`;
      case 'rain':
        return `<svg viewBox="0 0 32 32" width="32" height="32" fill="none"><ellipse cx="16" cy="14" rx="10" ry="8" fill="#90caf9"/><rect x="10" y="22" width="2" height="6" rx="1" fill="#2196f3"/><rect x="15" y="22" width="2" height="6" rx="1" fill="#2196f3"/><rect x="20" y="22" width="2" height="6" rx="1" fill="#2196f3"/></svg>`;
      case 'wind':
        return `<svg viewBox="0 0 32 32" width="32" height="32" fill="none"><path d="M6 20h20M10 24h12M8 16h16" stroke="#81d4fa" stroke-width="3" stroke-linecap="round"/></svg>`;
      default:
        return '';
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    addClassToFormFields();

    // MAPA
    const defaultCenter = [13.7, -89.2];
    function getInput(name) {
      const el = document.querySelector('input[name="' + name + '"]');
      return el ? el.value : null;
    }
    const latVal = parseFloat(getInput('latitude')) || null;
    const lonVal = parseFloat(getInput('longitude')) || null;
    const center = (latVal && lonVal) ? [latVal, lonVal] : defaultCenter;

    if (typeof L !== 'undefined') {
      const map = L.map('crop-map').setView(center, 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

      let marker = null;
      if (latVal && lonVal) {
        marker = L.marker([latVal, lonVal]).addTo(map);
        updateClimateFeedback(latVal, lonVal);
      }

      map.on('click', async function (e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        // Move or create marker
        if (marker) {
          marker.setLatLng([lat, lng]);
        } else {
          marker = L.marker([lat, lng]).addTo(map);
        }

        // Set hidden inputs
        const latIn = document.querySelector('input[name="latitude"]');
        const lonIn = document.querySelector('input[name="longitude"]');
        if (latIn) latIn.value = lat.toFixed(6);
        if (lonIn) lonIn.value = lng.toFixed(6);

        // Update climate feedback and calendar
        await updateClimateFeedback(lat, lng);

        // Update calendar colors after clicking
        const days = document.querySelectorAll('#calendar-container .calendar-day');
        days.forEach(function(day) {
          const rand = Math.random();
          if (rand < 0.6) {
            day.style.background = '#28a745';
            day.style.color = '#fff';
          } else if (rand < 0.85) {
            day.style.background = '#ffc107';
            day.style.color = '#333';
          } else {
            day.style.background = '#dc3545';
            day.style.color = '#fff';
          }
        });
      });
    }
  });
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

{% endblock %}
