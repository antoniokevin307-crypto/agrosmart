{% extends "base.html" %}
{% block content %}
<div class="ia-chat-fullscreen" style="background:#f8f9fa;display:flex;flex-direction:column;align-items:center;min-height:60vh;">
  <div id="ia-messages" style="flex:1 1 auto;overflow-y:auto;padding:32px 0 90px 0;max-width:700px;width:100%;margin:0 auto;">
    <!-- Mensajes se agregan aquí -->
  </div>
  <div style="width:100%;display:flex;justify-content:center;">
    <form id="ia-chat-form" style="display:flex;gap:10px;padding:18px 16px;background:#fff;box-shadow:0 -2px 12px #0066cc22;align-items:center;justify-content:center;max-width:700px;width:100%;border-radius:0.7rem;position:relative;" onsubmit="return sendIaChat();">
      <input id="ia-chat-input" type="text" placeholder="Escribe tu pregunta..." style="flex:1 1 220px;padding:14px 18px;border-radius:8px;border:1px solid #ccc;font-size:1.15rem;max-width:400px;margin:0 auto;" autocomplete="off" />
      <button type="submit" style="background:#0066cc;color:#fff;border:none;border-radius:8px;padding:14px 28px;font-size:1.15rem;margin:0 auto;">Enviar</button>
    </form>
  </div>
  <div id="ia-loading" style="display:none;position:fixed;bottom:80px;left:50%;transform:translateX(-50%);text-align:center;z-index:101;">
    <span class="spinner" style="display:inline-block;width:32px;height:32px;border:4px solid #eee;border-top:4px solid #0066cc;border-radius:50%;animation:spin 1s linear infinite;"></span>
    <div style="color:#888;font-size:.98rem;margin-top:8px;">La IA está pensando...</div>
  </div>
  <style>
    @keyframes spin { 100% { transform: rotate(360deg); } }
    #ia-messages::-webkit-scrollbar { width: 8px; background: #eee; }
    #ia-messages { scrollbar-width: thin; scrollbar-color: #0066cc #eee; }
    #ia-chat-form { justify-content: center; }
  </style>
</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
function appendIaMessage(role, text, imageUrl) {
  const box = document.getElementById('ia-messages');
  const div = document.createElement('div');
  div.style.margin = '18px 0';
  div.style.padding = '0 24px';
  div.style.wordBreak = 'break-word';
  if (role === 'IA') {
    let html = `<div style='font-weight:600;color:#0066cc;margin-bottom:4px;'>${role}:</div>`;
    html += `<div class='ia-markdown'>${marked.parse(text)}</div>`;
    if (imageUrl) {
      html += `<div style='margin:18px 0;text-align:center;'>
        <img src='${imageUrl}' alt='Imagen generada por IA' style='max-width:100%;border-radius:12px;box-shadow:0 2px 12px #0066cc22;' onerror="this.onerror=null;this.src='https://via.placeholder.com/400x250?text=Imagen+no+disponible';">
        <div style='color:#888;font-size:.95rem;margin-top:6px;'>Imagen generada por IA</div>
      </div>`;
    }
    div.innerHTML = html;
  } else {
    div.innerHTML = `<div style='font-weight:600;color:#333;margin-bottom:4px;'>${role}:</div><div>${text}</div>`;
  }
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}
function sendIaChat() {
  const input = document.getElementById('ia-chat-input');
  const question = input.value.trim();
  if (!question) return false;
  input.value = '';
  appendIaMessage('Tú', question);
  const loading = document.getElementById('ia-loading');
  loading.style.display = 'block';
  fetch('/ai/chat/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({ question })
  })
    .then(response => response.json())
    .then(data => {
      loading.style.display = 'none';
      if (data.ok) {
        appendIaMessage('IA', data.answer, data.image_url);
      } else {
        appendIaMessage('IA', `Error: ${data.answer}`);
      }
    })
    .catch(err => {
      loading.style.display = 'none';
      appendIaMessage('IA', `Error de red: ${err.message}`);
    });
  return false;
}
</script>
{% endblock %}
